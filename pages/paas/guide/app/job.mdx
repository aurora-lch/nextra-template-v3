# 任务管理

任务管理在通用算力平台中用于处理和监控各种计算任务。包括 Job 和 CronJob 两个部分。

![OVbtbbmDqonYTExVAUYcx8zUnNh](/static/OVbtbbmDqonYTExVAUYcx8zUnNh.png)

- Job 是 Kubernetes 中的一种工作负载，用于执行一次性或批处理任务，确保指定数量的 Pod 成功完成任务。
- CronJob 是用于基于时间表（Cron 表达式）执行任务的一种工作负载，适用于需要周期性或定时执行的任务。

## **创建步骤**

1. **选择集群**：在页面上选择任务将要部署的 Kubernetes 集群。
2. **选择命名空间**：从下拉列表中选择任务将要存放的命名空间。
3. **填写基本信息**：输入新任务的名称。
4. **任务设置：**

| **配置项**       | **描述**                                                     |
| ---------------- | ------------------------------------------------------------ |
| **任务类型**     | 一次性任务：一次性任务每次创建一个 Pod，直至一个 Pod 成功执行，任务执行完成。自定义任务：用户根据特定需求配置的任务，它可以包括特定的参数、环境变量或执行脚本。 |
| **最大重试次数** | 指定任务在遇到错误或失败时，系统将尝试重新执行的最大次数。   |
| **超时时间(s)**  | 当任务执行超出该时间时，任务将会被标识为执行失败，任务负载下的所有 Pod 实例都会被删除。为空时表示不设置超时时间 |

- **容器配置：**

| **配置项（基本信息）** | **描述**                                                     |
| ---------------------- | ------------------------------------------------------------ |
| **容器类型**           | - **工作容器**：Pod 中的主要容器，负责执行应用的主要业务逻辑。承载应用服务，如 Web 应用、数据处理服务等。- **初始化容器：**在工作容器启动之前运行的特殊容器，用于执行一些应用启动前的初始化任务。用于执行一次性的设置任务，如配置文件生成、依赖服务检查等。 |
| **容器名称**           | 必填。用于标识 Pod 内的不同容器。                            |
| **镜像拉取策略**       | - **If Not Present（优先使用本地镜像）：**如果本地有该镜像（之前拉取过该镜像至宿主机中），则使用本地镜像，本地不存在时拉取镜像。- **Always（总是拉取镜像）：**表示每次部署或扩容都会从容器镜像服务重新拉取镜像，而不会从本地拉取镜像。- **Never（仅使用本地镜像）：**仅使用本地镜像。 |
| **容器规格**           | 设置 CPU 资源的上限使用值。如果目标部署分区设置过资源限制的默认值，此处不填时系统将使用默认值。 |

| **配置项（容器端口设置）** | **描述**                                                     |
| -------------------------- | ------------------------------------------------------------ |
| **端口协议**               | - **TCP（传输控制协议）：**适用于需要可靠传输的应用，如 Web 浏览（HTTP）、文件传输（FTP）、邮件（SMTP）等。- **UDP（用户数据报协议）：**适用于对实时性要求高、可以容忍一定数据丢失的应用，如视频会议、在线游戏、DNS 查询等。 |
| **端口名称**               | 唯一的，在同一容器内不能重复。                               |
| **容器端口**               | 设置暴露的容器访问端口或端口名，端口号必须介于 1~65535。     |

| **配置项**       | **描述**                                                     |
| ---------------- | ------------------------------------------------------------ |
| **容器运行命令** | **启动命令：**容器启动时执行的第一条命令或脚本。             |
| **生命周期**     | - **启动命令：**用于执行容器启动后需要立即运行的任务，如初始化设置、预热缓存等。- **预终止命令：**用于执行容器关闭前需要完成的任务，如资源清理、优雅关闭服务等。 |
| **环境变量**     | 设置容器运行环境中的一些变量，便于部署后灵活变更容器配置。   |

- **挂载存储：**

| **配置项（添加存储卷）** | **描述**                                                     |
| ------------------------ | ------------------------------------------------------------ |
| **存储卷来源**           | - **PVC：**持久化存储。- **临时路径( EmptyDir )：**适用于临时存储，再难恢复，共享运行时数据等场景工作负载实例的删除或者迁移会导致临时路径被删除。- **主机路径（HostPath）：**将主机上的路径挂载到指定的容器路径。 |
| **存储卷名称**           | 填写存储卷的名称。                                           |
| **存储卷类型**           | - **文件储存：**适用于需要共享文件或目录的应用场景，例如共享配置文件、日志文件等。- **块储存：**适用于需要高性能、低延迟的存储场景，例如数据库存储、高性能计算等。 |
| **已有存储**             | 需先创建公共集群数据。                                       |

| **配置项（挂载配置文件或密钥）** | **描述**                                                     |
| -------------------------------- | ------------------------------------------------------------ |
| **配置项(ConfigMap )**           | - **存储卷名称：**填写存储卷的名称。- **配置项**- **istio-ca-root-cert：**通常用于 Istio 服务网格环境中，作为根证书来验证服务间通信的安全性。- **lhj-config：**可能是一个特定应用的配置文件，用于存储应用的配置参数或初始化设置。 |
| **密钥( Secret )**               | - **存储卷名称：**填写存储卷的名称。- **密钥：**用于在容器内安全地存储和访问敏感信息，如数据库密码或 API 密钥。 |

- **高级设置：**

| **配置项**       | **描述**                                                     |
| ---------------- | ------------------------------------------------------------ |
| **标签**         | 一组键值对，用于标识和组织资源。                             |
| **注解**         | 用于存储非标识性的辅助信息。                                 |
| **终止宽限期**   | 请求删除 Pod 时允许的最长等待时间。默认 30 秒。当设置 0 时强制删除。和 PreStop 组合使用，优雅下线应用或通知其他服务和应用 |
| **重启策略**     | - **Always：**无论容器以什么状态终止，总是重启容器。适用于需要持续运行的应用，如 Web 服务器或后台任务处理程序。- **Never：**容器终止后，不重启容器。用于需要手动干预的应用，或作为批处理任务运行的容器，这些任务完成后不需要重启。- **OnFailure：**仅当容器由于错误而非正常退出时才重启容器。适用于批处理作业或任务，这些任务通常预期会成功完成，不需要在成功完成后重启。 |
| **Pod 亲和性**   | - **亲和性：**决定应用的 Pod 可以和哪些 Pod 部署在同一拓扑域。例如，对于相互通信的服务，可通过应用亲和性调度，将其部署到同一拓扑域（如同一个主机）中，减少它们之间的网络延迟。- **反亲和性：**决定应用的 Pod 不与哪些 Pod 部署在同一拓扑域。应用非亲和性调度的场景包括：将一个服务的 Pod 分散部署到不同的拓扑域（如不同主机）中，提高服务本身的稳定性。给予 Pod 一个节点的独占访问权限来保证资源隔离，保证不会有其他 Pod 来分享节点资源。把可能会相互影响的服务的 Pod 分散在不同的主机上。- **类型**- **硬亲和性（Required）：**如果满足不了这些条件，Pod 将不会被调度。- **软亲和性（Preferred）：**这些条件是优选的，但如果满足不了，Pod 仍然可以被调度到其他节点。- **主机拓扑域：**指定调度时作用域。用于实现更细粒度的亲和性规则，确保 Pod 根据物理或虚拟的拓扑结构进行调度。- **匹配标签**：标识节点的拓扑域信息。 |
| **节点调度策略** | - **定向调度-指定节点：**用户或管理员明确指定 Pod 应该运行的节点。- **定向调度-节点标签管理：**通过给节点添加标签，来指定 Pod 应该运行的节点集合。- **根据节点亲和性选择节点：**一种更灵活的调度策略，允许基于节点的标签来吸引（或排斥）Pod 调度。 |
| **容忍**         | 让 Pod 能够容忍（忽略）节点上的某些限制条件，从而允许 Pod 在这些节点上运行的机制。 |

- **创建**：完成所有配置项的添加后，点击【部署】按钮来生成任务。